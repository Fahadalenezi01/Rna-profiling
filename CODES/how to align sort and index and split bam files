
##### how to split bam based on barcodes
 samtools view -h /media/datavis/DATA/Fahad/SL3_BL2_BL3_BL4_1_11_24/calledSL3BL2BL3BL4.bam | awk '$0 ~ /^@/ || $0 ~ /BC:Z:EXP-PBC096_barcode06/' | samtools view -b -o barcode06.bam
 
 
 ####how to merge bam filess
 
 samtools merge -n -o merged.bam file1.bam file2.bam file3.bam


samtools merge -n -o merged_SL3.bam /home/datavis/Desktop/SL3_BL2_BL3_BL4_1_11_24_barcodes/barcode03.bam /home/datavis/Desktop/SL3_BL2_BL3_BL4_second_run/barcode03.bam /home/datavis/Desktop/SL3_BL2_BL3_BL4_third_run/called_SL3_BL2_BL3_BL4_third_run_bc03.bam /media/datavis/DATA/Fahad/SL3_18_09_2024/called_SL3_18_09_2024.bam

samtools merge -n -o merged_BL4.bam /home/datavis/Desktop/SL3_BL2_BL3_BL4_1_11_24_barcodes/barcode06.bam /home/datavis/Desktop/SL3_BL2_BL3_BL4_third_run/called_SL3_BL2_BL3_BL4_third_run_bc06.bam /home/datavis/Desktop/SL3_BL2_BL3_BL4_second_run/barcode06.bam


###convert bam to fastq
samtools fastq /home/datavis/Desktop/SL1/called_SL1.bam > /home/datavis/Desktop/SL1/called_SL1.fastq


####pre-alignment QC
NanoPlot --fastq /home/datavis/Desktop/SL1/called_SL1.fastq --outdir /home/datavis/Desktop/SL1/nanoplot_results_SL1 --plots kde --loglength


###alignment with minimap2

minimap2 -ax splice /home/datavis/Desktop/GRCh38.primary_assembly.genome.fa /home/datavis/Desktop/SL1/called_SL1.fastq > /home/datavis/Desktop/SL1/aligned_SL1.sam

###sam to bam
samtools view -S -b /home/datavis/Desktop/SL1/aligned_SL1.sam > /home/datavis/Desktop/SL1/aligned_SL1.bam


####filter bam for stringtie
samtools view -b -q 20 /home/datavis/Desktop/SL1/aligned_SL1.bam > /home/datavis/Desktop/SL1/filtered_aligned_SL1.bam


#####sort and index filtered bam and execute StringTie

samtools sort -o /home/datavis/Desktop/SL1/filtered_aligned_SL1.sorted.bam /home/datavis/Desktop/SL1/filtered_aligned_SL1.bam && samtools index /home/datavis/Desktop/SL1/filtered_aligned_SL1.sorted.bam && stringtie /home/datavis/Desktop/SL1/filtered_aligned_SL1.sorted.bam -G /home/datavis/Desktop/gencode.v47.primary_assembly.basic.annotation.gtf -o /home/datavis/Desktop/SL1/stringtie_output_SL1.gtf -A /home/datavis/Desktop/SL1/stringtie_abundance_SL1.txt -e -B




## how to quantify alignment with stringtie

stringtie sample1.sorted.bam -G /home/datavis/Desktop/gencode.v47.primary_assembly.basic.annotation.gtf -o sample1.gtf -A sample_gene_abundance.txt


####plot output for R
library(dplyr); read.delim("/home/datavis/Desktop/BL1/stringtie_abundance_BL1.txt", header = TRUE, sep="\t", stringsAsFactors = FALSE) %>% arrange(desc(as.numeric(Coverage))) %>% head(20)






####R
#!/usr/bin/env Rscript
library(pheatmap)

# Use absolute path for the input file
input_file <- "/home/datavis/Desktop/BL4/aligned_sorted_BL4_gene_count.txt"

# Read the expression data; adjust header, sep, etc., as needed
expr <- read.table(input_file, header = TRUE, sep = "\t", row.names = 1)

# Log-transform the data (adding a pseudocount of 1 to avoid log(0))
expr_log <- log2(expr + 1)

# Specify the absolute path for the output heatmap image
output_heatmap <- "/home/datavis/Desktop/heatmap_BL4_featurcount.png"

# Generate and save the heatmap
pheatmap(expr_log,
         clustering_distance_rows = "euclidean",
         clustering_distance_cols = "euclidean",
         filename = output_heatmap_BL4)

# Example approach using the rtracklayer package
# install.packages("rtracklayer")
library(rtracklayer)

gtf_data <- import("/home/datavis/Desktop/gencode.v47.primary_assembly.basic.annotation.gtf")
# Convert to a data.frame
gtf_df <- as.data.frame(gtf_data)

# Filter for rows that are type "gene"
gene_info <- gtf_df[gtf_df$type == "gene", c("gene_id", "gene_name")]
gene_info <- unique(gene_info)
# This should give a mapping of Ensembl gene IDs to gene names

expr <- read.table("/home/datavis/Desktop/stringtie_abundance_BL4.txt", header=TRUE, sep="\t", stringsAsFactors=FALSE)
# Suppose expr$Gene.ID corresponds to the Ensembl gene_id
merged_data <- merge(expr, gene_info, by.x="Gene.ID", by.y="gene_id", all.x=TRUE)





setwd("/home/datavis/Desktop")


data <- read.table("stringtie_abundance_BL4.txt", header = TRUE, sep = "\t")

library(pheatmap)

# Subset data to include only the top 100 expressed genes based on FPKM
top_genes <- head(data[order(-data$FPKM), ], 100)

# Create an expression matrix; adjust field names (e.g., 'FPKM', 'GeneID') based on your file's structure
expression_matrix <- as.matrix(log2(top_genes$FPKM + 1))
rownames(expression_matrix) <- top_genes$GeneID

# Generate the heatmap
pheatmap(expression_matrix,
         clustering_distance_rows = "euclidean",
         clustering_method = "complete",
         main = "Heatmap of Top Expressed Genes")
         
         
         
         
         
         
         
         
         
         last thing
         
Install biomaRt
install.packages("BiocManager")
BiocManager::install("biomaRt")

library(biomaRt)

# Connect to the Ensembl database
ensembl <- useEnsembl(biomart = "genes", dataset = "hsapiens_gene_ensembl")

# Get a mapping for your gene IDs
gene_ids <- unique(expr$Gene.ID)
gene_map <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol"),
                  filters = "ensembl_gene_id",
                  values = gene_ids,
                  mart = ensembl)

# Merge the mapping with your data
expr_annotated <- merge(expr, gene_map, by.x = "Gene.ID", by.y = "ensembl_gene_id", all.x = TRUE)

# Replace blank or missing hgnc_symbol with the original Gene.ID
expr_annotated$Gene.Name <- ifelse(expr_annotated$hgnc_symbol == "" | is.na(expr_annotated$hgnc_symbol),
                                   expr_annotated$Gene.ID,
                                   expr_annotated$hgnc_symbol)

# Then proceed with subsetting and plotting as in the bar chart above:
top20 <- head(expr_annotated[order(expr_annotated$TPM, decreasing = TRUE), ], 20)
p <- ggplot(top20, aes(x = reorder(Gene.Name, TPM), y = TPM)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  coord_flip() +
  labs(title = "Top 20 Expressed Genes (TPM)", x = "Gene", y = "TPM") +
  theme_minimal(base_size = 14)
ggsave("/home/datavis/Desktop/top20_genes_barplot_annotated.png", plot = p, width = 8, height = 6)





# Load required libraries
library(ggplot2)
library(dplyr)

# Read the StringTie output file (adjust the file name if needed)
df <- read.table("/home/datavis/Desktop/stringtie_abundance_BL4.txt", header=TRUE, sep="\t", stringsAsFactors=FALSE)

# Check the structure of the data
str(df)




####filter stringtie output
grep -v 'MT-' /home/datavis/Desktop/BL4/stringtie_abundance_BL4.txt > /home/datavis/Desktop/BL4/filtered_stringtie_abundance_BL4.txt

