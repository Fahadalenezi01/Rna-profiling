# R Script for lncRNA Analysis - Step 2: Profiling & Visualization (Heatmap Fix 3 - Base R var)

# --- 0. Setup ---

# Install packages if you haven't already
# if (!requireNamespace("BiocManager", quietly = TRUE)) install.packages("BiocManager")
# if (!requireNamespace("DESeq2", quietly = TRUE)) BiocManager::install("DESeq2")
# if (!requireNamespace("dplyr", quietly = TRUE)) install.packages("dplyr")
# if (!requireNamespace("pheatmap", quietly = TRUE)) install.packages("pheatmap")
# if (!requireNamespace("ggplot2", quietly = TRUE)) install.packages("ggplot2")
# if (!requireNamespace("tibble", quietly = TRUE)) install.packages("tibble") # For rownames_to_column
# if (!requireNamespace("RColorBrewer", quietly = TRUE)) install.packages("RColorBrewer") # For heatmaps
# if (!requireNamespace("matrixStats", quietly = TRUE)) install.packages("matrixStats") # Still needed for other functions potentially

# Load libraries
library(DESeq2)
library(dplyr)
library(pheatmap)
library(ggplot2)
library(tibble) # For rownames_to_column
library(RColorBrewer) # For heatmaps
# library(matrixStats) # We will use base R var instead for the heatmap part

# --- 1. Configuration (!!! CHECK THESE PATHS !!!) ---

# Input Files (Should match filenames generated by the shell script)
transcript_count_file <- "/home/datavis/Desktop/lncRNA/lncRNA_pipeline_output/merged_transcript_counts.csv"
lncrna_ids_file <- "/home/datavis/Desktop/lncRNA/lncRNA_pipeline_output/lncRNA_identification/final_lncrna_transcript_ids.txt"

# Output Directory (Should exist from shell script, or create it)
analysis_output_dir <- "/home/datavis/Desktop/lncRNA/lncRNA_pipeline_output/lncRNA_analysis_results"
output_prefix <- "lncRNA_profile_" # Prefix for output files from this script

# Parameters for DESeq2 "One-vs-Rest" analysis
log2fc_threshold_profile <- 1.5 # Log2 Fold change threshold for sample-specific profile (e.g., 1, 1.5, 2)
padj_threshold_profile <- 0.05   # Adjusted p-value threshold (e.g., 0.05, 0.01)

# --- End of User Configuration ---

# Create output directory if it doesn't exist
if (!dir.exists(analysis_output_dir)) {
  dir.create(analysis_output_dir, recursive = TRUE)
  cat("Created analysis output directory:", analysis_output_dir, "\n")
}

# --- 2. Load Data ---
cat("--- Loading Data ---\n")
# Load transcript count data generated by prepDE.py
count_data_all <- read.csv(transcript_count_file, header = TRUE, row.names = 1, check.names = FALSE)
cat("Loaded transcript count matrix. Dimensions:", dim(count_data_all)[1], "transcripts x", dim(count_data_all)[2], "samples\n")

# Load the list of identified lncRNA transcript IDs
lncrna_ids <- tryCatch({
    read.table(lncrna_ids_file, header = FALSE, stringsAsFactors = FALSE)$V1
}, error = function(e) {
    cat("Error loading lncRNA ID file:", conditionMessage(e), "\n")
    cat("Assuming empty list.\n")
    return(character(0)) # Return empty list if file is empty or fails to load
})
cat("Loaded", length(lncrna_ids), "lncRNA IDs from:", lncrna_ids_file, "\n")

if (length(lncrna_ids) == 0) {
    stop("FATAL ERROR: lncRNA ID list is empty. Cannot proceed with analysis.")
}

# --- 3. Filter Count Matrix for lncRNAs ---
cat("--- Filtering Count Matrix for lncRNAs ---\n")
# Check if rownames in count matrix match the format in the lncRNA ID list
cat("Example rowname from count matrix:", rownames(count_data_all)[1], "\n")
cat("Example lncRNA ID from list:", lncrna_ids[1], "\n")

# Find intersection of IDs present in both count matrix rownames and the lncRNA ID list
common_lncrna_ids <- intersect(rownames(count_data_all), lncrna_ids)
cat("Found", length(common_lncrna_ids), "lncRNA IDs present in the count matrix.\n")

if (length(common_lncrna_ids) == 0) {
  stop("FATAL ERROR: No matching lncRNA IDs found between the ID list and the count matrix rownames. \n Check ID formats in both files (e.g., using head command in terminal). \n Are you using the correct count file (transcript-level)?")
}

# Subset the count matrix to include only these lncRNAs
count_data_lncrna <- count_data_all[common_lncrna_ids, , drop = FALSE] # drop=FALSE keeps it a matrix even if only 1 row

# Ensure counts are integers for DESeq2 (prepDE can sometimes output fractional estimates)
count_data_lncrna <- round(count_data_lncrna)

cat("Filtered lncRNA count matrix dimensions:", dim(count_data_lncrna)[1], "lncRNAs x", dim(count_data_lncrna)[2], "samples\n")

# --- 4. Prepare Metadata (colData) ---
cat("--- Preparing Sample Metadata ---\n")
sample_names <- colnames(count_data_lncrna)
colData <- data.frame(row.names = sample_names)

# *** IMPORTANT: Add known conditions if available ***
# For example, if first 4 are Blood (BL) and next 3 are Saliva (SL):
# sample_types <- factor(c(rep("Blood", 4), rep("Saliva", 3)))
# Ensure the order EXACTLY matches the column order in count_data_lncrna
# colData$SampleType <- sample_types

# Add sample names as a column to colData
colData$SampleName <- sample_names

print(colData) # Verify metadata looks correct

# Check if sample names match - CRITICAL!
if(!all(rownames(colData) == colnames(count_data_lncrna))){
  stop("FATAL ERROR: Mismatch between metadata row names and lncRNA count data column names! Check column names in CSV vs sample names used.")
}
cat("Metadata prepared for samples:", paste(sample_names, collapse=", "), "\n")


# --- 5. Quality Control & Visualization ---
cat("--- Performing QC and Visualization ---\n")

# Create a DESeqDataSet object (needed for normalization and QC plots)
design_formula <- if ("SampleType" %in% names(colData)) ~SampleType else ~1
dds_qc <- DESeqDataSetFromMatrix(countData = count_data_lncrna,
                                 colData = colData,
                                 design = design_formula)

# Variance Stabilizing Transformation (VST) or rlog
vsd <- tryCatch({
    vst(dds_qc, blind = TRUE, nsub=min(2000, nrow(dds_qc))) # Use vst if possible
}, error = function(e) {
    cat("VST failed, attempting rlog transformation instead. Error was:", conditionMessage(e), "\n")
    rlog(dds_qc, blind = TRUE) # Fallback to rlog
})

cat("Performed count transformation (VST or rlog).\n")

# 5a: PCA Plot
pca_filename <- file.path(analysis_output_dir, paste0(output_prefix, "PCA_plot.png"))
cat("Generating PCA plot:", pca_filename, "\n")
pca_intgroup <- if ("SampleType" %in% names(colData)) "SampleType" else "SampleName"
pcaData <- plotPCA(vsd, intgroup = pca_intgroup, returnData = TRUE)
percentVar <- round(100 * attr(pcaData, "percentVar"))
color_group <- pca_intgroup

pca_plot <- ggplot(pcaData, aes(x = PC1, y = PC2, color = .data[[color_group]], label = name)) +
  geom_point(size = 3) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  coord_fixed() +
  ggtitle("PCA Plot of lncRNA Expression (VST/rlog)") +
  geom_text(aes(label=name), vjust=1.5, size=3, check_overlap = TRUE) +
  theme_bw()
ggsave(pca_filename, plot = pca_plot, width = 8, height = 7)

# 5b: Sample Distance Heatmap
dist_filename <- file.path(analysis_output_dir, paste0(output_prefix, "Sample_Distance_Heatmap.png"))
cat("Generating Sample Distance heatmap:", dist_filename, "\n")
sampleDists <- dist(t(assay(vsd)))
sampleDistMatrix <- as.matrix(sampleDists)
rownames(sampleDistMatrix) <- colData(vsd)$SampleName
colnames(sampleDistMatrix) <- NULL
colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)
annotation_col_param <- if(ncol(colData) > 1) colData else NA
pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         col = colors,
         main = "Sample Distances based on lncRNA Expression",
         annotation_col = annotation_col_param,
         filename = dist_filename)

# 5c: Gene Expression Heatmap (Top Variable Genes)
heatmap_filename <- file.path(analysis_output_dir, paste0(output_prefix, "Top_Variable_lncRNA_Heatmap.png"))
cat("Generating heatmap of top variable lncRNAs:", heatmap_filename, "\n")
# --- !!! FIX 3: Use base R apply function for variance !!! ---
# Convert assay data to a standard matrix
vsd_assay_matrix <- as.matrix(assay(vsd))
# Calculate row variances using apply (1 indicates rows)
# Add na.rm=TRUE in case transformation introduced NAs
rv <- apply(vsd_assay_matrix, 1, var, na.rm = TRUE)
# --- End Fix 3 ---
num_variable_genes <- min(50, nrow(vsd_assay_matrix))

# Check if rv calculation resulted in NAs (e.g., if a row had zero variance)
if (any(is.na(rv))) {
    cat("Warning: NA values found in row variance calculation. Removing them before ordering.\n")
    # Keep only non-NA variances for ordering
    rv_filtered <- rv[!is.na(rv)]
    # Get the names (lncRNA IDs) corresponding to the non-NA variances
    names_filtered <- names(rv_filtered)
    # Order the filtered variances
    select <- order(rv_filtered, decreasing = TRUE)
    # Get the names of the top N genes from the filtered list
    topVarGeneNames <- head(names_filtered[select], num_variable_genes)
    # Subset the original matrix using these names
    mat_heatmap <- vsd_assay_matrix[topVarGeneNames, , drop=FALSE]

} else if (length(rv) > 1 && num_variable_genes > 0) {
    # If no NAs and enough rows, proceed as before
    select <- order(rv, decreasing = TRUE)
    topVarGeneNames <- head(rownames(vsd_assay_matrix)[select], num_variable_genes)
    mat_heatmap  <- vsd_assay_matrix[topVarGeneNames, , drop=FALSE]
} else {
    # Handle cases with insufficient data
     mat_heatmap <- NULL # Ensure mat_heatmap is defined but NULL
     cat("Skipping gene expression heatmap: Not enough data or variable genes found.\n")
}

# Proceed with heatmap generation only if mat_heatmap was created
if (!is.null(mat_heatmap) && nrow(mat_heatmap) > 0) {
    annotation_col_param_heatmap <- if(ncol(colData) > 1) colData else NA
    pheatmap(mat_heatmap,
             scale = "row",
             cluster_rows = TRUE, cluster_cols = TRUE,
             show_rownames = (num_variable_genes <= 50),
             show_colnames = TRUE,
             annotation_col = annotation_col_param_heatmap,
             main = paste("Top", nrow(mat_heatmap), "Variable lncRNAs"), # Use actual number plotted
             filename = heatmap_filename)
} else {
     cat("Skipping gene expression heatmap generation.\n")
}


# --- 6. One-vs-Rest Analysis for Sample-Specific lncRNAs ---
cat("\n--- Performing One-vs-Rest DESeq2 Analysis ---\n")

results_list <- list() # Store results for each sample

# Loop through each sample name (column name in the count matrix)
for (target_sample in sample_names) {

  cat("Processing sample:", target_sample, "as target...\n")

  # 1. Create the 'condition' column for this specific comparison
  colData_loop <- colData
  colData_loop$condition <- ifelse(rownames(colData_loop) == target_sample, "Target", "Rest")
  colData_loop$condition <- factor(colData_loop$condition, levels = c("Rest", "Target"))

  # 2. Create DESeqDataSet object for this comparison
  dds_loop <- DESeqDataSetFromMatrix(countData = count_data_lncrna,
                                     colData = colData_loop,
                                     design = ~ condition)

  # 3. Run DESeq2 analysis
  dds_loop <- tryCatch({
      DESeq(dds_loop)
  }, error = function(e) {
      cat("   ERROR during DESeq() for", target_sample, ":", conditionMessage(e), "\n")
      cat("   Skipping results extraction for this sample.\n")
      return(NULL)
  })

  # Skip if DESeq failed
  if (is.null(dds_loop)) {
       results_list[[target_sample]] <- data.frame()
       next
  }

  # 4. Get results for the contrast "Target" vs "Rest"
  res_loop <- results(dds_loop, contrast = c("condition", "Target", "Rest"), alpha = padj_threshold_profile)

  # Optional: Remove rows with NA adjusted p-values
  res_loop <- na.omit(res_loop)

  # 5. Filter for significantly *upregulated* lncRNAs in the target sample
  res_significant_up <- subset(res_loop, log2FoldChange > log2fc_threshold_profile & padj < padj_threshold_profile)

  # Order results by adjusted p-value
  res_significant_up <- res_significant_up[order(res_significant_up$padj), ]

  cat("   Found", nrow(res_significant_up), "significantly upregulated lncRNAs specific to", target_sample, "\n")

  # 6. Save the results to a file and store in list
  output_filename <- file.path(analysis_output_dir, paste0(output_prefix, "specific_to_", target_sample, ".csv"))
  res_df <- as.data.frame(res_significant_up) %>%
            rownames_to_column(var = "transcript_id")
  write.csv(res_df, file = output_filename, row.names = FALSE)
  cat("   Saved specific lncRNA profile to:", output_filename, "\n")

  results_list[[target_sample]] <- res_df

} # End of loop through samples

# --- 7. Summary ---
cat("\n--- Analysis Complete ---\n")
cat("Results and plots saved in directory:", analysis_output_dir, "\n")
cat("Summary of specific lncRNAs found per sample (log2FC >", log2fc_threshold_profile, ", padj <", padj_threshold_profile, "):\n")
for(sample in names(results_list)) {
  num_rows <- if(is.data.frame(results_list[[sample]])) nrow(results_list[[sample]]) else 0
  cat("  - ", sample, ": ", num_rows, "\n")
}


